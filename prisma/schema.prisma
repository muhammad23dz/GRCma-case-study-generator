// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// Next-Auth Models
model Account {
  id                 String  @id @default(cuid())
  userId             String
  type               String
  provider           String
  providerAccountId  String
  refresh_token      String?
  access_token       String?
  expires_at         Int?
  token_type         String?
  scope              String?
  id_token           String?
  session_state      String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String?   @unique
  emailVerified DateTime?
  image         String?
  role          String    @default("user") // user, admin, manager
  orgId         String?
  
  accounts      Account[]
  sessions      Session[]
  reports       Report[]
  organization  Organization? @relation(fields: [orgId], references: [id])
  
  @@index([orgId])
  @@index([role])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model Report {
  id        String   @id @default(cuid())
  userId    String
  sections  String   // JSON string of report sections
  timestamp DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

// ============================================
// FEATURE 1: CONTROL LIBRARY & FRAMEWORK MAPPING
// ============================================

model Control {
  id                   String   @id @default(cuid())
  title                String
  description          String
  controlType          String   // preventive, detective, corrective, directive
  owner                String?
  controlRisk          String?  // low, medium, high, critical
  evidenceRequirements String?
  confidence           Float?   // LLM mapping confidence 0-1
  llmProvenance        String?  // JSON: {prompt, model, temperature, timestamp}
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  
  mappings             FrameworkMapping[]
  evidences            Evidence[]
  risks                Risk[]
  actions              Action[]
  
  @@index([controlType])
  @@index([owner])
}

model FrameworkMapping {
  id           String   @id @default(cuid())
  controlId    String
  framework    String   // e.g., "ISO27001", "SOC2", "NIST"
  requirement  String   // e.g., "A.5.1.1", "CC6.1"
  description  String?
  confidence   Float?   // LLM mapping confidence
  createdAt    DateTime @default(now())
  
  control      Control  @relation(fields: [controlId], references: [id], onDelete: Cascade)
  
  @@index([controlId])
  @@index([framework])
}

// ============================================
// FEATURE 2: RISK ASSESSMENT
// ============================================

model Risk {
  id         String    @id @default(cuid())
  assetId    String?
  likelihood Int       // 1-5 scale
  impact     Int       // 1-5 scale
  score      Int       // likelihood Ã— impact
  category   String    // e.g., "privacy", "security", "operational"
  narrative  String    // LLM-generated risk description
  status     String    @default("open") // open, mitigated, accepted, transferred
  controlId  String?
  owner      String?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  
  control    Control?  @relation(fields: [controlId], references: [id])
  evidences  Evidence[]
  
  @@index([category])
  @@index([status])
  @@index([score])
  @@index([owner])
}

// ============================================
// FEATURE 3: THIRD-PARTY RISK (VENDOR MANAGEMENT)
// ============================================

model Vendor {
  id                  String   @id @default(cuid())
  name                String
  description         String?
  category            String   // e.g., "cloud provider", "saas", "contractor"
  riskScore           Int      // 0-100
  contractStart       DateTime?
  contractEnd         DateTime?
  lastAssessmentDate  DateTime?
  nextAssessmentDate  DateTime?
  status              String   @default("active") // active, inactive, pending
  owner               String?
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  
  assessments         VendorAssessment[]
  evidences           Evidence[]
  
  @@index([category])
  @@index([status])
  @@index([riskScore])
  @@index([owner])
}

model VendorAssessment {
  id                String   @id @default(cuid())
  vendorId          String
  assessmentDate    DateTime
  assessor          String
  questionsAsked    String   // JSON array
  questionsAnswered String   // JSON array
  riskScore         Int      // 0-100
  findings          String?  // LLM summary
  recommendations   String?  // LLM suggestions
  status            String   @default("draft") // draft, final, approved
  
  vendor            Vendor   @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  
  @@index([vendorId])
  @@index([assessmentDate])
}

// ============================================
// FEATURE 4: EVIDENCE \u0026 COMPLIANCE
// ============================================

model Evidence {
  id                 String   @id @default(cuid())
  controlId          String?
  riskId             String?
  vendorId           String?
  evidenceType       String   // document, screenshot, log, certification
  description        String
  fileUrl            String?
  fileName           String?
  summary            String?  // LLM-generated summary
  verificationStatus String   @default("pending") // pending, verified, rejected
  uploadedBy         String
  timestamp          DateTime @default(now())
  
  control            Control? @relation(fields: [controlId], references: [id])
  risk               Risk?    @relation(fields: [riskId], references: [id])
  vendor             Vendor?  @relation(fields: [vendorId], references: [id])
  
  @@index([controlId])
  @@index([riskId])
  @@index([vendorId])
  @@index([evidenceType])
  @@index([uploadedBy])
}

model EvidenceFile {
  id         String   @id @default(cuid())
  evidenceId String
  fileName   String
  fileUrl    String
  fileSize   Int      // bytes
  fileType   String   // mime type
  uploadedBy String
  uploadedAt DateTime @default(now())
  
  @@index([evidenceId])
}

model Attestation {
  id         String   @id @default(cuid())
  controlId  String
  statement  String   // LLM-drafted attestation
  attestedBy String
  attestedAt DateTime
  validUntil DateTime?
  signature  String?  // digital signature or approval hash
  status     String   @default("active") // active, expired, revoked
  createdAt  DateTime @default(now())
  
  @@index([controlId])
  @@index([status])
}

// ============================================
// FEATURE 5: PLAYBOOKS \u0026 RUNBOOKS
// ============================================

model Playbook {
  id          String   @id @default(cuid())
  scenario    String   // e.g., "data breach", "system outage"
  description String
  steps       String   // JSON array of action steps
  llmModel    String?  // Model used to generate
  createdBy   String
  createdAt   DateTime @default(now())
  
  @@index([scenario])
}

// ============================================
// FEATURE 6: ACTION TRACKING
// ============================================

model Action {
  id          String    @id @default(cuid())
  title       String
  description String?
  status      String    @default("open") // open, in_progress, completed, cancelled
  priority    String    @default("medium") // low, medium, high, critical
  assignedTo  String?
  dueDate     DateTime?
  controlId   String?
  incidentId  String?
  owner       String?
  createdAt   DateTime  @default(now())
  completedAt DateTime?
  updatedAt   DateTime  @updatedAt
  
  control     Control?  @relation(fields: [controlId], references: [id])
  incident    Incident? @relation(fields: [incidentId], references: [id])
  
  @@index([status])
  @@index([assignedTo])
  @@index([dueDate])
  @@index([priority])
  @@index([owner])
}

// ============================================
// FEATURE 7: POLICY MANAGEMENT
// ============================================

model Policy {
  id          String   @id @default(cuid())
  title       String
  version     String   @default("1.0")
  content     String   // Full policy text
  status      String   @default("draft") // draft, active, archived
  owner       String
  reviewDate  DateTime?
  approvedBy  String?
  approvedAt  DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([status])
  @@index([owner])
}

// ============================================
// FEATURE 8: INCIDENT MANAGEMENT
// ============================================

model Incident {
  id          String    @id @default(cuid())
  title       String
  description String
  severity    String    // low, medium, high, critical
  status      String    @default("open") // open, investigating, resolved, closed
  reportedBy  String
  assignedTo  String?
  rootCause   String?
  remediation String?
  createdAt   DateTime  @default(now())
  resolvedAt  DateTime?
  updatedAt   DateTime  @updatedAt
  
  actions     Action[]
  
  @@index([status])
  @@index([severity])
  @@index([assignedTo])
}

model Organization {
  id        String   @id @default(cuid())
  name      String
  createdAt DateTime @default(now())
  
  users     User[]
}

// ============================================
// PREMIUM FEATURE: AUDIT TRAIL & ACTIVITY LOGGING
// ============================================

model AuditLog {
  id         String   @id @default(cuid())
  userId     String   // Who made the change
  userName   String
  userEmail  String
  entity     String   // "control", "risk", "policy", "vendor", etc.
  entityId   String
  action     String   // "created", "updated", "deleted"
  changes    String   // JSON of before/after values
  ipAddress  String?
  userAgent  String?
  timestamp  DateTime @default(now())
  
  @@index([userId])
  @@index([entity])
  @@index([entityId])
  @@index([timestamp])
}
